{# app/ticket_management/templates/tickets/client_manage_completed_ticket.html #}
{% extends "base.html" %}

{% block title %} {{ title }} {% endblock %}

{% block content %}
    <div class="container">
        <h1 class="my-4">{{ title }}</h1>
        <hr>

        <p><strong>ID del Ticket:</strong> {{ ticket._id | string }}</p>
        <p><strong>Título:</strong> {{ ticket.title }}</p>
        <p><strong>Categoría:</strong> {{ category_map[ticket.category_value] }}</p>
        <p><strong>Estado Actual:</strong> 
            {% set status_class = {
                'cancelled': 'bg-danger',
                'completed': 'bg-success'
            }.get(ticket.status_value, 'bg-secondary') %}
            <span class="badge rounded-pill {{ status_class }}">{{ status_map[ticket.status_value] }}</span>
        </p>
        <p><strong>Descripción:</strong> {{ ticket.description }}</p>
        {# Opcional: Mostrar notas internas para el cliente si aplica #}
        {% if ticket.internal_notes %}
            <div class="card mt-3">
                <div class="card-header">Notas del Operador:</div>
                <div class="card-body">
                    <p class="card-text" style="white-space: pre-wrap;">{{ ticket.internal_notes }}</p>
                </div>
            </div>
        {% endif %}
        
            <div class="d-flex justify-content-center">
                <a href="{{ url_for('operator_bp.ticket_history', ticket_id=ticket._id | string) }}" class="btn btn-outline-secondary col-md-10">
                        <i class="fas fa-history"></i> Ver Historial
                </a>
            </div>
        <hr class="my-4">

        <h3>Acciones del Cliente</h3>
        <p>El operador ha marcado este ticket como **{{ status_map[ticket.status_value] }}**.</p>
        <p>Por favor, decide si el trabajo está completado a tu satisfacción o si necesitas rechazarlo.</p>

        <div class="d-flex justify-content-center gap-3 mt-4">
            {# Botón para Cerrar el Ticket #}
            <form action="{{ url_for('client_bp.close_ticket', ticket_id=ticket._id | string) }}" method="POST" class="col-md-12">
                {{ form.csrf_token }} {# Usamos el token del formulario de rechazo para seguridad #}
                <button type="submit" class="btn btn-info close-ticket-confirm-btn">Cerrar Ticket</button>
            </form>
        </div>
        <div class="d-flex flex-column flex-md-row gap-3 mt-4">
            {# Formulario para Rechazar el Ticket #}
            <div class="card p-3 flex-grow-1">
                <h5 class="card-title">Rechazar Ticket</h5>
                <form method="POST" action="{{ url_for('client_bp.client_manage_completed_ticket', ticket_id=ticket._id | string) }}">
                    {{ form.csrf_token }}
                    <div class="mb-3">
                        {{ form.note.label(class="form-label") }}
                        {{ form.note(class_="form-control", rows=4, placeholder="Explica por qué rechazas el ticket...") }}
                        {% if form.note.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.note.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {{ form.submit() }}
                </form>
            </div>
        </div>
            <a href="{{ url_for('client_bp.client_tickets') }}" class="btn btn-secondary mt-4">Volver a Mis Tickets</a>
        </div>
    </div>
    <div class="modal fade" id="actionConfirmModal" tabindex="-1" aria-labelledby="actionConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionConfirmModalLabel">Confirmar Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="actionConfirmModalBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="actionConfirmButton">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts_extra %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const actionConfirmModal = new bootstrap.Modal(document.getElementById('actionConfirmModal'));
            const actionConfirmButton = document.getElementById('actionConfirmButton');
            const actionConfirmModalLabel = document.getElementById('actionConfirmModalLabel');
            const actionConfirmModalBody = document.getElementById('actionConfirmModalBody');

            let formToSubmit = null;

            // Selecciona todos los botones que necesitan confirmación aquí
            const specificActionButtons = document.querySelectorAll('.close-ticket-confirm-btn, .reject-ticket-confirm-btn');

            specificActionButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // Previene el envío inmediato

                    formToSubmit = this.closest('form'); // Guarda el formulario asociado

                    // Personaliza el texto del modal
                    const customMessage = this.dataset.confirmMessage || "¿Está seguro de realizar esta acción?";
                    actionConfirmModalBody.textContent = customMessage;
                    actionConfirmModalLabel.textContent = this.textContent.trim() + " Ticket"; // P.ej. "Cerrar Ticket" o "Rechazar Ticket"

                    actionConfirmModal.show();
                });
            });

            actionConfirmButton.addEventListener('click', function() {
                actionConfirmModal.hide();
                if (formToSubmit) {
                    // Usa la misma técnica de tempButton.click() para asegurar validaciones
                    const tempButton = document.createElement('button');
                    tempButton.style.display = 'none';
                    tempButton.type = 'submit';
                    formToSubmit.appendChild(tempButton);
                    tempButton.click();
                    setTimeout(() => {
                        formToSubmit.removeChild(tempButton);
                    }, 100);
                }
            });
        });
    </script>
{% endblock %}